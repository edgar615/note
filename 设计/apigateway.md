API网关

http://dockone.io/article/482

http://tech.youzan.com/gateway/

当你决定将应用作为一组微服务时，需要决定应用客户端如何与微服务交互。在单体式程序中，通常只有一组冗余的或者负载均衡的服务提供点。在微服务架构中，每一个微服务暴露一组细粒度的服务提供点.

如果由客户端直接与各个微服务通信，会有一些缺点：

- 某些复杂场景下客户端可能需要发起多次调用才能得到想要的资源，增加客户端的复杂度
- 要求各个微服务使用web友好的协议（HTTP、WebSocket等）
- 由于客户端和微服务耦合，很难重构或拆分微服务

因此通常来说，一个更好的解决办法是采用API Gateway的方式。

# API Gateway
API Gateway是一个服务器，也可以说是进入系统的唯一节点。这跟面向对象设计模式中的Facade模式很像。API Gateway封装内部系统的架构，并且提供API给各个客户端。它还可能有其他功能，如授权、监控、负载均衡、缓存、请求分片和管理、静态响应处理等。

API Gateway负责请求转发、合成和协议转换。

- 进入系统的唯一节点，所有的客户端请求都要先经过API Gateway,然后在将这些请求路由到对应的微服务
- 经常通过调用多个微服务以及聚合多个微服务的结果来处理一个请求
- 在web协议与内部使用的非Web友好型协议间进行转换，如HTTP协议、WebSocket协议。
- 封装内部系统的架构，并且提供API给各个客户端
- 授权、监控、负载均衡、缓存、请求分片和管理、静态响应处理等

## API Gateway的优点和缺点
API Gateway的一个最大好处是封装应用内部结构。相比起来调用指定的服务，客户端直接跟gatway交互更简单点。API Gateway提供给每一个客户端一个特定API，这样减少了客户端与服务器端的通信次数，也简化了客户端代码。

API Gateway也有一些缺点。它是一个高可用的组件，必须要开发、部署和管理。还有一个问题，它可能成为开发的一个瓶颈。开发者必须更新API Gateway来提供新服务提供点来支持新暴露的微服务。更新API Gateway时必须越轻量级越好。否则，开发者将因为更新Gateway而排队列。但是，除了这些缺点，对于大部分的应用，采用API Gateway的方式都是有效的。

# 实现
我根据公司一些项目的要求，使用Vert.x实现了一个API网关:Direwolves（尚未正式完成）

网关系统主要分为三个部分

**Definition**

负责API路由规则的定义，不同的API可能有不同的处理逻辑，为了灵活的处理这种情况，每个API除了基本的转发规则外，还可以通过一系列的插件来扩展

**Dispatch**

负责API请求的转发，通过一系列的Filter来实现参数校验，鉴权、限流等功能

Filter分为PRE和POST两种。PRE类型的filter在RPC调用之前执行，POST类型的filter在RPC调用之后执行。新定义一个插件一般都需要定义一个filter。

**Monitor**
使用基于Vert.x的Dropwizard度量实现了针对不同API的度量指标

