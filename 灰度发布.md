物联网平台从V1.2升级到V1.3的时候由于跨度很大，由于升级准备不充分，出现了很多未预料到的问题。为了解决这个问题考虑引入灰度发布的设计

https://mp.weixin.qq.com/s?__biz=MzAwMjgwMTEzNw==&mid=404295511&idx=1&sn=70334b1b1c5be597c8036987e56b30a2&3rd=MzA3MDU4NTYzMw==&scene=6#rd

http://fpliu-blog.chinacloudsites.cn/it/web/server/gray-release


http://so.factj.com/yunqi/articles/117331

http://www.ttlsa.com/linux/meizu-ad-http-api-sou/


# 灰度发布

灰度发布指能够达到平滑过渡的一种发布方式。

灰度发布的目的主要有：

    规避一定的发布风险，降低全线升级所引起的潜在故障危害。
    分流控制，灵活选择用户参与产品测试。逐步扩大用户。
    快速获取用户的使用情况，完善产品功能，提升产品质量。

其中的要点是能够灵活精准选取参与使用的用户，全面准确的获取灰度用户使用情况信息，分析、总结、完善；达到降低发布风险、减少bug带来的影响。

# Nginx层处理

可以直接在Nginx上使用lua脚本根据灰度规则将用户的请求转发到不同的下游服务上——由于公司的技术、资源的局限性，并没有使用这个方案

# 网关层处理

考虑在API网关上加入灰度规则，实现灰度发布

## 灰度规则设计

1. 按比例放量：指定接口版本，根据灰度比例到某个新版本接口，比如V1请求的用户，需要放量20%到V2接口，如果是全量灰度，只需将比例改为100%

2. 指定IMEI：指定IMEI（或IMEI通配）的用户灰度到某个新版本接口 ，比如 IMEI=123456或IMEI=123456*, 需要调用V2接口。

3. 全局规则：根据请求头（或者参数）中的version属性判断



 如何精确的筛选用户？

公共请求参数有appKey、IP、clientId（设备ID号），
业务请求参数由接口自定义控制，可根据实际的业务需求，配合使用接口所有参数，来达到用户筛选