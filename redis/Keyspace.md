### Redis Keyspace Notifications

在 Redis 里面有一些事件，比如键到期、键被删除等。然后我们可以通过配置一些东西来让 Redis 一旦触发这些事件的时候就往特定的 Channel 推一条消息。

本文所涉及到的需求的话我们所需要关心的事件是 `EXPIRE` 即过期事件。

大致的流程就是我们给 Redis 的某一个 db 设置过期事件，使其键一旦过期就会往特定频道推消息，我在自己的客户端这边就一直消费这个频道就好了。

以后一来一条定时任务，我们就把这个任务状态压缩成一个键，并且过期时间为距这个任务执行的时间差。那么当键一旦到期，就到了任务该执行的时间，Redis 自然会把过期消息推去，我们的客户端就能接收到了。这样一来就起到了定时任务的作用。

#### 消息类型

当达到一定条件后，有两种类型的这种消息会被触发，用哪个需要自己选了。举个例子，我们删除了在 db 0 中一个叫 `foo` 的键，那么系统会往两个频道推消息，一个是 `del` 事件频道推 `foo` 消息，另一个是 `foo` 频道推 `del` 消息，它们小俩口被系统推送的指令分别等价于：

```
PUBLISH __keyspace@0__:foo del
PUBLISH __keyevent@0__:del foo
```

其中往 `foo` 推送 `del` 的频道名为 `__keyspace@0__:foo`，即是 `"__keyspace@" + DB_NUMBER + "__:" + KEY_NAME`；而 `del` 的频道名为 `"__keyevent@" + DB_NUMBER + "__:" + EVENT_NAME`。

#### 配置

即使你的 Redis 版本达标了，但是 Redis 默认是关闭这个功能的，你需要修改配置文件来打开它，或者直接在 CLI 里面通过指令修改。这里就说说配置文件的修改吧。

如果不想看我在这里罗里吧嗦的，也可以直接去看 Redis 的[相关文档](http://redis.io/topics/notifications#configuration)。

首先打开 Redis 的配置文件，在不同的系统和安装方式下文件位置可能不同，比如通过 `brew` 安装的 MacOS 下可能是在 `/usr/local/etc/redis.conf` 下面，通过 `apt-get` 安装的 Ubuntu 下可能是在 `/etc/redis/redis.conf` 下，总之找到配置文件。**或者自己写一个配置文件，启动的时候指定配置文件地址就好。**

然后找到一项叫 `notify-keyspace-events` 的地方，如果找不到则自行添加，其值可以是 `Ex`、`Klg` 等等。这些字母的具体含义如下所示：

- **K**，表示 `keyspace` 事件，有这个字母表示会往 `__keyspace@<db>__` 频道推消息。
- **E**，表示 `keyevent` 事件，有这个字母表示会往 `__keyevent@<db>__` 频道推消息。
- **g**，表示一些通用指令事件支持，如 `DEL`、`EXPIRE`、`RENAME` 等等。
- **$**，表示字符串（String）相关指令的事件支持。
- **l**，表示列表（List）相关指令事件支持。
- **s**，表示集合（Set）相关指令事件支持。
- **h**，哈希（Hash）相关指令事件支持。
- **z**，有序集（Sorted Set）相关指令事件支持。
- **x**，过期事件，与 **g** 中的 `EXPIRE` 不同的是，**g** 的 `EXPIRE` 是指执行 `EXPIRE key ttl` 这条指令的时候顺便触发的事件，而这里是指那个 `key` 刚好过期的这个时间点触发的事件。
- **e**，驱逐事件，一个 `key` 由于内存上限而被驱逐的时候会触发的事件。
- **A**，`g$lshzxe` 的别名。也就是说 `AKE` 的意思就代表了所有的事件。

结合上述列表我们就能拼凑出自己所需要的事件支持字符串了，在我的需求中我只需要 `Ex` 就可以满足了，所以配置项就是这样的：

```
notify-keyspace-events Ex
```

然后保存配置文件，启动 Redis 就启用了过期事件的支持了。