灰度发布



http://fpliu-blog.chinacloudsites.cn/it/web/server/gray-release

https://www.zhihu.com/question/20584476

https://mp.weixin.qq.com/s?__biz=MzAwMjgwMTEzNw==&mid=404295511&idx=1&sn=70334b1b1c5be597c8036987e56b30a2&3rd=MzA3MDU4NTYzMw==&scene=6#rd

http://www.ttlsa.com/linux/meizu-ad-http-api-sou/

http://dockone.io/article/2118

# 灰度发布
在大型软件产品发布过程中，为慎重起见， 一般都会经历Pre-Alpha、Alpha、Beta、RC(Release Candidate)、RTM、GA (General availability or General Acceptance)等几个阶段。 产品的发布过程不是一蹴而就，而是逐步扩大使用用户的范围。
可以看出，对于大型软件的发布是分阶段的。 一般是从团队内部 → 部门内部 → 公司内部 → 外部小范围测试 → 外部大范围测试 → 正式发布， 涉及的用户数也是逐步放量的过程。
在大型互联网产品的发布过程中，也较多采用此种发布方式： 从公司内部用户 → 忠诚度较高的种子用户 → 更大范围的活跃用户 → 所有用户。 在此过程中，产品团队根据用户的反馈及时完善产品相关功能。
灰度发布实际上就是从不发布，然后逐渐过渡到正式发布的一个过程。
灰度发布是一种试探性发布。因为他不确定新版本会对用户造成什么影响，所以选择让一部分用户使用新服务， 如果发现用户好评如潮，就逐渐扩大用户升级规模，最后让全部用户升级到新服务。
灰度发布对海量用户的App发布非常有效。
# 灰度需求
随着业务的不断发展，需求变更，接口迭代越来越频繁，便有了灰度的需求，比如历史接口A，在上线新功能后，希望将线上历史接口A的部分请求转发到新功能模块上，来验证新功能代码是否可靠，也就是说灰度目的如下：

**减低全线升级引起的潜在故障危害，采用灰度升级，根据结果反馈接口质量**

在软件设计层面较为抽象，就是：

**客户端调用接口和参数不变，需要将满足条件的请求转发到对应的新方法，也就是我们所说的新接口**

我们可以在两个软件层动工来满足我们的需求，一是在Nginx层做灰度规则判断，二是在网关层做灰度规则判断
# 灰度规则设计

1. 比例放量：指定接口版本，根据灰度比例到某个新版本接口，比如V1请求的用户，需要放量20%到V2接口，如果是全量灰度，只需将比例改为100%
2. 指定用户：指定的用户（IP，Cookie,IMEI）灰度到某个新版本接口 ，比如 IMEI=123456或IMEI=123456*, 需要调用V2接口。
3. 全局规则：广告业务中有这样的一个优先级高的灰度需求，就是比如某些IMEI（或IMEI通配）需要返回特定的数据，而不能走正常业务逻辑处理流程。而且 目前IDC调用接口已有多个版本，不能针对每个版本配置一条规则，所以我们引入了全局规则记录，灰度规则的匹配流程如下：

## 1.由调用方指定版本号
 对于APP应用，可以在网关使用请求头实现一个很简单的灰度规则的逻辑。
 这个方案更多的适用于服务端多版本兼容，这样服务端可以兼容不同版本的API，逐步删除一些过时的API。
1. 调用方发送服务端请求是加上版本号的请求头，如：
```
x-api-verson : 20171108 #建议直接用日期来表示版本
```
2. 不同版本的API定义好不同的版本
3. 定义一个带有HeaderGrayPlugin插件的API。（可以重新定义一个新的API，也可以在原有的API上定义，推荐前者）
#### Plugin: VersionPlugin
用于定义API版本的插件， #建议直接用日期来表示版本（GrayFilter并没有实现复杂的版本比较）
配置
```
"version": "20171108"
```
- **version**，对应版本号，使用日期格式。

**注意：多版本共存是API的名称不能重复**
#### Plugin: HeaderGrayPlugin
用来声明基于请求头的灰度发布规则
配置
```
"gray.header": "floor" 
```
**gray.header**用来指明在未匹配到`x-api-version`声明的版本时时，采用哪种方式匹配API。
- **floor** 匹配最低的版本
- **ceil** 匹配最高的版本
#### Filter: HeaderGrayFilter
如果请求头中带有`x-api-version`则执行这个Filter。 如果未找到合适的API，返回404（资源不存在），如果匹配到多个API，返回500（数据冲突）。

- **type** PRE
- **order** -2147482748

**前置条件**：上下文中不存在API

在引入了plugin-gray包之后GrayFilter会在ApiFindFilter之前执行，如果通过GrayFilter找到了合适的API，那么ApiFindFilter不会再执行。

~~因为调用方的鉴权是在查找API之后进行的，所以无法实现基于用户的灰度规则，但是将来我们可以扩展基于用户IP、按比例放量的灰度规则~~

## 1.基于用户/设备的比例灰度
对于每个设备，维护一个唯一的device_id，device_id的最后两个数应该是0-9中任意的一个数（最好能平均分配），通过这两个数字可以实现1%~100%的灰度功能


PS

我们完成应用程序包的分发工作后，需要去停止当前应用上的程序，并完成新应用的启动。应用重新启动后，我们需要进行校验从而完成这台应用服务器上的应用发布。对应用的校验一般是由应用自身提供一个检测脚本或者页面，发布系统执行这个脚本或者访问页面后来判断返回的结果。
在停止应用时，如果采用暴力方式，就会影响当时正在执行的请求，所以需要优雅地关闭。但是如果持续有新请求进入的话，是很难优雅关闭应用的，所以需要控制不能有新请求进人。这就需要在负载均衡或者软负载中心上做文章，也就是需要在关闭应用前把这个应用从负载均衡或软负载中心上移去，然后再优雅地关闭应用 (结束当前所有请求后关闭)，然后进行新应用的启动友检查，检查逋过后，再把这个应用加人到负载均衡或者软负载上，并对外提供应用。

从整个集群的视角来看，对于单机应用的下线、重启、上线的操作，需要总体控制同时进行这个操作的应用服务器的数量。因为如果一个集群中过多的应用下线的话，剩下在线的应用可能不能负担当时所有的请求，而同时去操作的应用服务器的数量或比例一定是可调的。