# 日志

http://tech.lede.com/2017/06/30/rd/server/loggingHabit/

在做系统的过程中一直在思考如何能够让系统日志更加精炼，机器，人都能很清楚的阅读日志。在参考了网上很多文章后，我确定了一个自己使用的日志标准

## 日志级别

- **ERROR**

  ERROR是最高级别错误，反映系统发生了非常严重的故障，无法自动恢复到正常态工作，需要人工介入处理。系统需要将错误相关痕迹以及错误细节记录ERROR日志中，方便后续人工回溯解决。

- **WARN**

  WARN是低级别异常日志，反映系统在业务处理时触发了异常流程，但系统可恢复到正常态，下一次业务可以正常执行。但WARN级别问题需要开发人员给予足够关注，往往表示有参数校验问题或者程序逻辑缺陷，当功能逻辑走入异常逻辑时，应该考虑记录WARN日志。

- **INFO**

  INFO日志主要记录系统关键信息，旨在保留系统正常工作期间关键运行指标，开发人员可以将初始化系统配置、业务状态变化信息，或者用户业务流程中的核心处理记录到INFO日志中，方便日常运维工作以及错误回溯时上下文场景复现。

- **DEBUG**

  DEBUG日志是INFO日志的好帮手，开发人员可以将各类详细信息记录到DEBUG里，起到调试的作用，包括参数信息，调试细节信息，返回值信息等等。其他等级不方便显示的信息都可以通过DEBUG日志来记录。

## 记录日志的时机

  在看线上日志的时候，我们可曾陷入到日志泥潭？该出现的日志没有，无用的日志一大堆，或者需要的信息分散在各个角落，特别是遇到紧急的在线bug时，有效的日志被大量无意义的日志信息淹没，焦急且无奈地浪费大量精力查询日志。那什么是记录日志的合适时机呢？

总结几个需要写日志的点：

1. **编程语言提示异常**：如今各类主流的编程语言都包括异常机制，业务相关的流行框架有完整的异常模块。这类捕获的异常是系统告知开发人员需要加以关注的，是质量非常高的报错。应当适当记录日志，根据实际结合业务的情况使用warn或者error级别。
2. **业务流程预期不符**：除开平台以及编程语言异常之外，项目代码中结果与期望不符时也是日志场景之一，简单来说所有流程分支都可以加入考虑。取决于开发人员判断能否容忍情形发生。常见的合适场景包括外部参数不正确，数据处理问题导致返回码不在合理范围内等等。
3. **系统核心角色，组件关键动作**：系统中核心角色触发的业务动作是需要多加关注的，是衡量系统正常运行的重要指标，建议记录INFO级别日志，比如电商系统用户从登录到下单的整个流程；微服务各服务节点交互；核心数据表增删改；核心组件运行等等，如果日志频度高或者打印量特别大，可以提炼关键点INFO记录，其余酌情考虑DEBUG级别。
4. **系统初始化**：系统或者服务的启动参数。核心模块或者组件初始化过程中往往依赖一些关键配置，根据参数不同会提供不一样的服务。务必在这里记录INFO日志，打印出参数以及启动完成态服务表述。

SR： Server Received 服务端收到请求.

SS：Server Send，服务端处理完请求，向客户端返回.

CS：Client Send，客户端向服务端（包括下游服务，DB等等）发起请求.

CR：Client Received 客户端收到服务端的响应.

LOG：本地产生的一些业务日志，比如：请求成功，请求失败.

SES：Server Event send，向Eventbus发送事件，主要是对send请求的回应

SER：Server Event Received，从eventbus收到事件.

CES：Client Event send，向Eventbus发送事件.

CER：Client Event Received，从eventbus中接受事件，主要是对send请求的回应.

MS：Message Send 向消息服务器发送时间

MR: Message Received，从消息服务器读取事件

SP: 程序（方法）的运行开始

EP：程序（方法）运行结束



格式

```
[服务名] [跟踪ID(可忽略)] [日志类型] [子分类] [关键数据] [message] 
```





下面的格式已经废弃

## ---> 表示API请求

格式

	---> [x-request-id] [HTTP] [HTTP方法 请求地址] [请求头，用;分隔，无请求头输出no header] [请求参数，用;分隔，无参数输出no param] [请求体，无请求体输出no body]

示例

	---> [d3af2bf8-b640-4c6a-97fb-d3181d83f941] [http] [GET /appkey/import] [content-type:application/json;Host:127.0.0.1:9003;] [no param] [no body]

## ---| 表示内部调用过程
格式

	---| [x-request-id] [OK | FAILED] [方法] [描述]

示例

	---| [3682506f-5587-4ff7-83b5-302e91f977c0] [OK] [ApiFindFilter] [PRE]
	---| [3682506f-5587-4ff7-83b5-302e91f977c0] [OK] [ResponseTransformerFilter] [POST]
	---| [be923e13-972d-4bf0-b5c0-62a4b876026d] [FAILED] [ApiFindFilter] [failed match api]

## ------> 表示远程调用
### HTTP格式

	------> [远程调用ID] [HTTP] [远程调用地址] [HTTP方法 请求地址] [请求头，用;分隔，无请求头输出no header] [请求参数，用;分隔，无参数输出no param] [请求体，无请求体输出no body]

示例

	------> [d3af2bf8-b640-4c6a-97fb-d3181d83f941.1] [HTTP] [localhost:52624] [GET /companies] [x-request-id:d3af2bf8-b640-4c6a-97fb-d3181d83f941.1;] [limit:100;start:0;state:1;] [no body]

### DUMMY格式

	------> [远程调用ID] [DUMMY] [JSON对象]

示例

	------> [0c7963ab-3126-40e3-8305-92fb6fa42269.1] [DUMMY] [{"userId":-188,"username":"backend","permissions":"all","role":"backend"}]

### Eventbus格式

	------> [远程调用ID] [EVENTBUS] [pub-sub | point-point | req-resp] [事件地址] [事件头，用;分隔，无请求头输出no header] [请求体，无请求体输出no body]

示例

	------> [1da1a8a5-94c8-4492-a623-fbe3164b5faf.1] [EVENTBUS] [req-resp] [example.direwolves.eb.api.list] [no header] [{}]

## <------ 表示远程调用返回
### HTTP格式

	<------ [远程调用ID] [HTTP] [OK|FAILED] [响应码] [耗时] [响应字节数]

示例

	<------ [d3af2bf8-b640-4c6a-97fb-d3181d83f941.1] [HTTP] [OK] [200] [18ms] [4807 bytes]

### DUMMY格式

	<------ [远程调用ID] [DUMMY] [OK|FAILED] [耗时] [响应字节数]

示例

	<------ [0c7963ab-3126-40e3-8305-92fb6fa42269.1] [DUMMY] [OK] [0ms] [73 bytes]

### Eventbus格式

	<------ [远程调用ID] [EVENTBUS] [OK|FAILED] [耗时] [响应字节数]

示例

	<------ [1da1a8a5-94c8-4492-a623-fbe3164b5faf.1] [EVENTBUS] [OK] [18ms] [3991 bytes]

## <--- 表示API响应
格式

	<--- [x-request-id] [http] [响应码] [响应头，用;分隔，无请求头输出no header] [耗时] [响应字节数]

示例

	<--- [d3af2bf8-b640-4c6a-97fb-d3181d83f941] [http] [200] [content-type:application/json;charset=utf-8;x-request-id:d3af2bf8-b640-4c6a-97fb-d3181d83f941;Transfer-Encoding:chunked;x-response-time:37ms;] [38ms] [4807 bytes]

## ======> 表示发送消息
格式

	======> [消息ID] [类型：MESSAGE | REQUEST | RESPONSE] [OK | FAILED] [消息主题或地址] [消息标识] [消息头，没有消息头的显示no header] [消息内容，没有消息内容的显示no body]

示例

	======> [4f82021b-84b8-44a1-9b0f-6d4b024b966d] [MESSAGE] [OK] [user-1ddd54a] [user.insert] [header{from=user-12, to=user-1ddd54a, group=user, action=MESSAGE, id=4f82021b-84b8-44a1-9b0f-6d4b024b966d, timestamp=1489650972, sequence=null}] [Message{content={foo=bar}, resource=user.insert, caption=insert, description=null}]

## <====== 表示收到的消息
格式

	<====== [消息ID] [类型MESSAGE | REQUEST | RESPONSE] [消息主题或地址] [消息标识]  [消息头，没有消息头的显示no header] [消息内容，没有消息内容的显示no body]

示例

	  <====== [8eea6dc7-17d5-4ce8-a36d-f8a9a3514b6a] [MESSAGE] [user-1ddd54a] [user.insert] [header{from=user-12, to=user-1ddd54a, group=user, action=MESSAGE, id=8eea6dc7-17d5-4ce8-a36d-f8a9a3514b6a, timestamp=1489650972, sequence=null}] [Message{content={foo=bar}, resource=user.insert, caption=insert, description=null}]

## ===> 表示eventbus接收到的消息

	===> [消息ID] [消息地址] [消息头，用;分隔，无消息头输出no header] [消息体，无消息体输出no body]

示例

	===> [2671b4f1-e6e1-49e3-a41b-c1429b4f7ab2] [direwolves.eb.api.get] [no header] [{"name":"FEpRaRdKjn"}]

## <=== 表示eventbus向发送方回应消息
### HTTP格式

	<=== [消息ID] [OK|FAILED] [耗时] [响应字节数,成功的消息才有] [异常描述，失败的消息才有]

示例

	<=== [be5a9599-5936-45e5-811f-fc4626cb3c5f] [OK] [17ms] [166 bytes]
	<===  [2375af3a-397d-476b-9682-db5325600a14] [FAILED] [13ms] [Resources Not Found]