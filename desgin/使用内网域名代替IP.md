https://mp.weixin.qq.com/s/-kOYRHKPAKwjGS4jhSh-pA

**什么是耦合？**

耦合，是架构中，本来不相干的代码、模块、服务、系统因为某些原因联系在一起，各自独立性差，影响则相互影响，变动则相互变动的一种架构状态。

**感官上，怎么发现系统中的耦合？**

作为技术人，每每在心中骂上下游，骂兄弟部门，“这个东西跟我有什么关系？为什么需要我来配合做这个事情？”。明明不应该联动，却要被动配合，就可能有潜在的耦合。

**因为IP配置，导致上下游必须联动，就是一个耦合的典型案例。**

**场景还原**

线上有一台数据库服务器，因为某种原因，例如磁盘故障，要进行更换。运维部署了一台新机器，DBA部署好数据库实例，做好了数据，只等调用方切换。

**如何切换呢？**

原来数据库有个旧IP，现在有个新IP，要通知上游将流量切到新IP上来，怎么办？

一一通知上游切换呗。找到上游，抱歉，IP换了，麻烦修改配置重启一下，连到新的IP上去。

![img](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzmHdUtaJia2IwTK9IDFIUZITjGcHupq4km8PwGtmo1GT6nfySvrZ3tSBibQccu1UF1zdMO2ia5bHDYw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1)

不知道大家工作中会不会遇到这样的场景，数据库或者服务的IP换了，你作为上游的调用方，需要配合修改配置重启。此时你心里可能就在骂娘了，明明变化IP的是别人，为什么配合修改配置重启的人是我。

特别的，如果变换IP的是一个基础服务或者一个基础数据库，调用它的上游很多，那么可能A部门、B部门、C部门，要全部找一遍，全部配合修改配置重启。

所以这个因为IP配置使得上下游耦合在一起的案例，其耦合范围非常广的，**理想的情况是**：谁修改IP，只有一处修改，流量就能默默迁移过去，这就是解耦。

**如何解除IP耦合？**

**常见的方法是**：使用内网域名替代内网IP，如果没有做这个优化，强烈的建议马上实施，将配置文件中的内网IP全部干掉，全部改为内网域名。

**使用内网域名，就不需要上游配合重启了吗？**

假设现在不用内网IP，改用内网域名了，一个服务或者数据库的IP变更，只需要一个地方更改，而不是所有上游更改：

![img](https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzmHdUtaJia2IwTK9IDFIUZIc84WZS6nZRIMia8D7zYYhQRL7Ju6ujxdWbDYZCsHEmQgrcvCbwzOvsQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1)

- **运维修改内网DNS，将内网域名指向新的IP**，如果是短连接调用，未来新的请求流量，自然会切到新的IP上；如果是长连接调用，新的长连接会连到新的IP上，但旧的长连接仍然连接的是旧IP
- **运维统一将旧IP上的连接切断**，如无意外，服务或者数据库的连接池都有重连功能，重连后就会自动连到新IP上去

如此这般，只要运维配合就可以完成IP的迁移，对于所有上游的调用方不需要配合修改配置重启。

**使用内网域名来替换内网IP**，只是一个很小的优化点，但对于IP解耦却是非常的有效。



内网域名环境的搭建可以查看linux的`dnsmasq`文档